<?php

namespace App\Console\Commands;

use Carbon\Carbon;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class DataTransfer extends Command
{

    protected $signature = 'sync:data
                            {--region-name=Scout Labs : Region name in contour_regions table}
                            {--chunk=500 : Number of records to process per chunk}';

    protected $description = 'Sync data from Scout Labs tables (scout_labs_traps, scout_labs_records) to Contour tables (contour_locations, contour_trap_counts)';

    /*
     * Transfers data from 'weather'->'scout_labs_taps' to 'contour_locations' as well as
     * data from 'weather'->'scout_labs_records' to 'contour_trap_counts' respectively
     *
     * Returns: an integer; 0 represents success, 1 represents failure
     */
    public function handle(): int
    {
        DB::beginTransaction(); // wrap as a transaction

        // From Jesse's example, go back a year + 1 month
        $endDate = now()->startOfDay()->subYear()->subMonth();
        $startDate = $endDate->copy()->subDays(30);

        // Format the dates
        $endDate = $endDate->format('Y-m-d H:i:s');
        $startDate = $startDate->format('Y-m-d H:i:s');

        try {
            $regionName = $this->option('region-name') ?: 'Scout Labs';
            $chunkSize = (int)$this->option('chunk');

            $regionId = DB::table('contour_regions')
                ->where('name', $regionName)
                ->value('id');

            // check that the region was found, throw error if not
            if (!$regionId) {
                $this->error("Region '{$regionName}' not found in contour_regions.");
                return Command::FAILURE;
            }

            // get the locations we have in contour_locations
            $locations = DB::table('contour_locations')->where('contour_region_id', $regionId)->get('name');
            // dd($locations); // now have 35 traps from contour_locations

            $combinedRecords = collect(); // for gathering records

            foreach($locations as $location) {
                // gather all the ScoutLabs records
                $records = DB::connection('weather')->table('scout_labs_records')
                    ->where('trap_id', $regionId) // check for correct regionID
                    ->whereBetween('recorded_at', [$startDate, $endDate]) // date clamping
                    ->get();
                $combinedRecords->push($records);
            }
            
            dd($combinedRecords); // collection of the records found above

            DB::connection('weather')
                ->table('scout_labs_records')
                ->orderBy('id')
                ->chunk($chunkSize, function ($records) {
                    $gatheredRecords = []; // to hold transfer data
                    foreach ($records as $record) { // for each trap record
                        $gatheredRecords[] = [ // add counts & id
                            'location_id' => $record->location_id,
                            'count' => $record->count,
                        ];
                    }
                });

            /*
             * INSERTION
             * 
            // insert trap records (aka trap counts)
            DB::table('scout_labs_records')->insert($gatheredRecords);
            $this->info('Finished syncing records.');

            // insert the gathered trap (i.e. not records) data
            DB::table('contour_locations')->insert($gatheredTraps);
            $this->info('Finished syncing traps.');

            DB::commit(); // everything should be ok, can commit to DB
            */
            return Command::SUCCESS;
        } catch (\Exception $e) {
            DB::rollBack(); // error occurred, do not commit to DB
            $this->error("Sync failed: " . $e->getMessage());
            Log::error("Scout Labs sync error", ['exception' => $e]);
            return Command::FAILURE;
        }
    }
}
