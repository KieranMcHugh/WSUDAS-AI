<?php

namespace App\Console\Commands;

use Carbon\Carbon;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class DataTransfer extends Command
{

    protected $signature = 'sync:data
                            {--region-name=Scout Labs : Region name in contour_regions table}
                            {--chunk=500 : Number of records to process per chunk}';

    protected $description = 'Sync data from Scout Labs tables (scout_labs_traps, scout_labs_records) to Contour tables (contour_locations, contour_trap_counts)';

    /*
     * Transfers data from 'weather'->'scout_labs_taps' to 'contour_locations' as well as
     * data from 'weather'->'scout_labs_records' to 'contour_trap_counts' respectively
     *
     * Returns: an integer; 0 represents success, 1 represents failure
     */
    public function handle(): int
    {
        DB::beginTransaction(); // wrap as a transaction

        // From Jesse's example, go back a year + 1 month
        $endDate = now()->startOfDay()->subYear()->subMonth();
        $startDate = $endDate->copy()->subDays(30);

        // Format the dates
        $endDate = $endDate->format('Y-m-d H:i:s');
        $startDate = $startDate->format('Y-m-d H:i:s');

        try {
            // get the model's id from model_cards (currently just for NOW)
            // TODO: Do not hardcode to Navel Orangeworm?
            $modelCardId = DB::table('model_cards')
                ->where('code', 'NOW') // search for Navel Orangeworm
                ->where('country', 'US') // only get results in the U.S.
                ->first()->id; // get the pest's id

            $regionName = $this->option('region-name') ?: 'Scout Labs';
            $chunkSize = (int)$this->option('chunk');

            $regionId = DB::table('contour_regions')
                ->where('name', $regionName)
                ->value('id');

            // check that the region was found, throw error if not
            if (!$regionId) {
                $this->error("Region '{$regionName}' not found in contour_regions.");
                return Command::FAILURE;
            }

            // gets all of the smapp_ids stored in contour_locations
            $locations = DB::table('contour_locations')->where('contour_region_id', $regionId)->get('name');
            // dd($locations); // now have 35 traps from contour_locations

            $combinedRecords = collect(); // for gathering records

            // TODO: when creating collection, location name should be key to collection

            foreach($locations as $location) {
                // for each ScoutLabs record
                $trap = DB::connection('weather')->table('scout_labs_traps')
                    ->where('smapp_id', $location->name)
                    ->first();

                $records = DB::connection('weather')->table('scout_labs_records')
                    ->where('trap_id', $trap->id) // check for correct regionID
                    ->whereBetween('recorded_at', [$startDate, $endDate]) // date clamping
                    ->get();

                //dd($records); // collection of the records found above
                $combinedRecords->push($records);
            }

            dd($combinedRecords); // collection of the records found above

            // insert trap records (aka trap counts)
            // need to convert dates to sundays
            // need to transfer model_id for NOW (for U.S. data specifically)
            // location_id in contour_trap_counts directly relates to contour_locations' id
            // get ID from contour_locations using collection key (aka name)
            // create a new collection, can then insert
            // can do that as a bulk insert once it is an array (using toArray())


            // DB::table('contour_trap_counts')->insert();
            $this->info('Finished syncing records.');

            DB::commit(); // everything should be ok, can commit to DB

            return Command::SUCCESS;
        } catch (\Exception $e) {
            DB::rollBack(); // error occurred, do not commit to DB
            $this->error("Sync failed: " . $e->getMessage());
            Log::error("Scout Labs sync error", ['exception' => $e]);
            return Command::FAILURE;
        }
    }
}
